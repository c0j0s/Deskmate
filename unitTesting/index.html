<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Welcome to Teachers portal</title>
<script src="jquery.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
</head>
<body>
<div class="container">
<div id="data">

</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

//The Firebase SDK is initialized and available here!
var config = {
apiKey: "AIzaSyB29exuhOXpePNSnW4UaGd8dhSppgYbYTo",
authDomain: "deskmate2018.firebaseapp.com",
databaseURL: "https://deskmate2018.firebaseio.com",
projectId: "deskmate2018",
storageBucket: "deskmate2018.appspot.com",
messagingSenderId: "876434687063"
};
firebase.initializeApp(config);

var homeworkDB = firebase.database().ref('/profile/0001/homework');
var questionDB = firebase.database().ref('/question');
var paperName = "1";
var questionNumber = 2;
var paperid;

var userDB = firebase.database().ref('/profile/0001')    
const messageDB = firebase.database().ref('/messages');
getMessages()
function getMessages(){
        var userID = '0001'
        var senderName = 'ken';
        if(senderName !== ''){
            console.log('sender: '+ senderName)
        }

        return new Promise(resolve => {
            var userMessageList = [];
            messageDB.once('value', snap =>{
                snap.forEach(message =>{
					message = message.val()
                    if(message.to === userID){
                        if(message.read === false){
                            if(senderName !== ''){
                                if(message.senderName.toLowerCase().includes(senderName.toLowerCase())){
									userMessageList.push(message)
                                }
                            }else{
							console.log(message)
                            userMessageList.push(message)
                            }
                        }
					}
			console.log(userMessageList)
					
            resolve(userMessageList)
                })
			})
        }).then(userMessageList => {
			var speech;
			console.log(userMessageList)
			console.log(userMessageList.length)
            if(userMessageList.length !== 0){
                speech = `You have ${userMessageList.length} new messages`
                if(senderName !== ''){
                    speech = speech + `from ${senderName}`
                }
                speech = speech + `, do you want me to read them?`
				console.log(speech)
				return speech
            }else{
                speech = `you have no new messages`
                if(senderName !== ''){
                    speech = speech + `from ${senderName}`
				}
				console.log(speech)
                return speech
            }
        }).catch(error => {
            console.log(error)
        });
    }

getUserHomeworks()
   function getUserHomeworks(){
        return new Promise(resolve => {
            var listOfPaper = {
                completed: [],
                notCompleted: []
            }
            homeworkDB.once('value',snapshot=>{
                snapshot.forEach(paper =>{
                    paper = paper.val();
                    if(paper.attempts === 0){
                        listOfPaper.notCompleted.push(paper.name)
                    }else{
                        listOfPaper.completed.push(paper.name)
                    }
                })
                resolve(listOfPaper)
            })
        }).then(listOfPaper =>{
			var speech;
			console.log(listOfPaper.notCompleted.length)
            if(listOfPaper.notCompleted.length !== 0){
                speech = `Currently you have ${listOfPaper.notCompleted.length} not completed homework, they are `
                listOfPaper.notCompleted.forEach((item,index) => {
                    if((listOfPaper.notCompleted.length - 1) === index){
                        speech = speech.slice(0, -2);
                        speech = speech + ' and ' + item + '.'
                    }else{
                        speech = speech + item + ', '
                    }
                })
            }else{
                speech = `Currently you have no new homework.`
            }
            console.log(speech)
            return 
        }).catch(error => {
            console.log(error)
            return 
        });
    }
    firebase.database().ref('/messages').child('0000000001').update({
            'read': true
        })

				});
</script>
</body>
</html>
